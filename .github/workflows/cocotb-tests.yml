name: Cocotb BIST Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Cocotb Tests

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Icarus Verilog
        run: |
          sudo apt-get update
          sudo apt-get install -y iverilog

      - name: Install cocotb
        run: pip install cocotb

      # â”€â”€ Unit Tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: "Test: LFSR Generator"
        working-directory: Test
        run: make -f Makefile test_lfsr

      - name: "Test: MISR Analyzer"
        working-directory: Test
        run: make -f Makefile test_misr

      - name: "Test: Idle Detector"
        working-directory: Test
        run: make -f Makefile test_idle

      - name: "Test: APB Slave Interface"
        working-directory: Test
        run: make -f Makefile test_apb

      - name: "Test: Ibex ALU"
        working-directory: Test
        run: make -f Makefile test_alu

      - name: "Test: Ibex MultDiv"
        working-directory: Test
        run: make -f Makefile test_multdiv

      - name: "Test: BIST Controller"
        working-directory: Test
        run: make -f Makefile test_bist_ctrl

      # â”€â”€ Integration Tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: "Integration: BIST Wrapper"
        working-directory: Test
        run: make -f Makefile test_wrapper

      - name: "Integration: Full System"
        working-directory: Test
        run: make -f Makefile test_system

      # â”€â”€ Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Collect Test Results
        if: always()
        working-directory: Test
        run: |
          echo "## ðŸ§ª Cocotb Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Module | Tests | Pass | Fail | Skip |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|------|------|------|" >> $GITHUB_STEP_SUMMARY

          for dir in sim_build/lfsr sim_build/misr sim_build/idle sim_build/apb \
                     sim_build/alu sim_build/multdiv sim_build/bist_ctrl \
                     sim_build/wrapper sim_build/system; do
            name=$(basename $dir)
            xml="../Test/$dir/../results.xml"

            # Try to find results.xml in sim_build subdirectories
            result_file="$dir/results.xml"
            if [ ! -f "$result_file" ]; then
              result_file="results.xml"
            fi

            if [ -f "$result_file" ]; then
              tests=$(grep -c 'testcase ' "$result_file" 2>/dev/null || echo "?")
              failures=$(grep -o 'failures="[0-9]*"' "$result_file" 2>/dev/null | head -1 | grep -o '[0-9]*' || echo "?")
              skips=$(grep -o 'skipped="[0-9]*"' "$result_file" 2>/dev/null | head -1 | grep -o '[0-9]*' || echo "0")
              pass=$((tests - failures - skips))
              if [ "$failures" = "0" ]; then
                echo "| âœ… $name | $tests | $pass | $failures | $skips |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| âŒ $name | $tests | $pass | $failures | $skips |" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "| âš ï¸ $name | â€” | â€” | â€” | â€” |" >> $GITHUB_STEP_SUMMARY
            fi
          done
